<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="https://img5.pic.in.th/file/secure-sv1/MTcircle.png" type="image/png">

    <title>Royal Point</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.form/4.3.0/jquery.form.min.js"></script>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"
    />

    <!-- Sanwithz Style -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/sanwithz/Form/sanwithzstyle2.min.css"
    />

    <!-- Sweet Alert -->
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Loading Overlay -->
    <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>

    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <!-- html5 qrcode -->
    <script
      src="https://unpkg.com/html5-qrcode"
      type="text/javascript"
    ></script>

    <style>
      .bg-silver {
        background: linear-gradient(135deg, #c0c0c0, #ffffff);
        color: #333;
      }

      .bg-gold {
        background: linear-gradient(135deg, #ffd700, #fff3b0);
        color: #333;
      }

      .bg-diamond {
        /*     background: linear-gradient(135deg, #b9f2ff, #e0f7ff); */
        background: linear-gradient(30deg, #3f87a6, #ebf8e1, #f69d3c);
        color: #333;
      }
      .bg-supreme {
        background: linear-gradient(135deg, #000000, #ebf8e1, #ffffff);
        color: #f69d3c;
      }

      #displaySection {
        display: none;
      }

      .h1,
      .h2,
      .h3,
      .h4,
      .h5,
      .h6,
      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        margin-top: 0;
        margin-bottom: 0;
      }

      .modal-fullscreen {
        width: 100%;
        max-width: none;
        height: 100%;
        margin: 0;
      }

      .modal-fullscreen .modal-content {
        width: 100%;
        height: 100%;
        border: 0;
        border-radius: 0;
      }

      .modal-fullscreen .modal-body {
        overflow-y: auto;
      }
    </style>
  </head>

  <body class="bg-light">
    <div class="container mt-2">
      

      <img
        src="https://lh3.googleusercontent.com/d/1AvLa6L3Xp-nJKy9ir6u2J2YmBeZtBDFW"
        class="card-img-top rounded-4"
        alt="Header"
      />

      <div id="regSection">
        <div class="mt-5">
         <h2 class="text-center" style="color: #2881c3;">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ VIP</h2>



          <form id="dataForm" class="list mt-3">
            <div class="mb-3">
              <!--             <label for="uid" class="form-label disable ">UID</label> -->
              <input
                type="text"
                class="form-control"
                id="uid"
                name="uid"
                style="display: none"
              />
            </div>
            <div class="mb-3">
              <label for="name" class="form-label">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
              <input
                type="text"
                class="form-control"
                id="name"
                name="name"
                required
              />
            </div>
            <div class="mb-3">
              <label for="sex" class="form-label">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
              <select class="form-control" id="room" name="room" required>
                <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
                <option value="‡∏ô‡∏≤‡∏¢‡∏ä‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏ç‡πà">‡∏ô‡∏≤‡∏¢‡∏ä‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏ç‡πà</option>
                <option value="‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£">‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£</option>
                <option value="‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô</option>
                <option value="‡∏Ñ‡∏£‡∏π/‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå">‡∏Ñ‡∏£‡∏π/‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå</option>
                <option value="‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="dob" class="form-label">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label>
              <input
                type="date"
                class="form-control"
                id="dob"
                name="dob"
                required
              />
            </div>
            <div class="mb-3">
              <label for="passport" class="form-label"><i class='bx bxs-building'></i>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</label>  
              <input
                type="text"
                class="form-control"
                id="passport"
                name="passport"
                required
              />
            </div>
            <div class="mb-3">
              <label for="telephone" class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
              <input
                type="text"
                class="form-control"
                id="telephone"
                name="telephone"
                required
              />
            </div>
            <button type="submit" class="btn btn-lg w-100" style="background-color: #2881c3; border-color: #2881c3; color: white;">
  ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
</button>

          </form>
        </div>
      </div>

      <div id="displaySection" class="list mt-2">
        <!-- User Info in Flex Row -->
        <div
          class="d-flex align-items-center bg-silver p-3 rounded-4 shadow-sm mb-3"
        >
          <img
            id="profilePic"
            src="https://placehold.co/60x60"
            class="rounded-circle border border-2 border-white shadow me-3"
            style="width: 60px; height: 60px"
          />

          <div>
            <div class="fw-bold fs-6" id="username">Thanin Pongyakate</div>
            <div class="text-muted small">
              <span>‡∏ä‡∏±‡πâ‡∏ô ‡∏°.6/99 ‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 99</span><br />
              <span id="phone"><i class="fas fa-phone"></i> 0906616611</span>
            </div>
          </div>
          <div class="ms-auto text-end">
            <div class="text-warning fw-bold" style="margin-right: 10px">
              <h2 style="color: #2881c3;"><i class="fas fa-coins"></i></h2>
<h2 id="points" style="color: #2881c3;">100000</h2>
<h5 style="color: #2881c3;">‡∏û‡πâ‡∏≠‡∏¢‡∏ó‡πå</h5>

              

            </div>
          </div>
        </div>

        <div class="text-center mt-2">
          <!-- Progress Curve -->
          <div>
            <svg viewBox="0 0 100 50" class="w-100">
              <!-- background circle -->
              <path
                d="M 10 50 A 40 40 0 0 1 90 50"
                stroke="#eee"
                stroke-width="10"
                fill="none"
              />

              <!-- foreground curve progress -->
              <path
                id="progressCurve"
                d="M 10 50 A 40 40 0 0 1 90 50"
                stroke="#2881c3"
                stroke-width="10"
                fill="none"
                stroke-dasharray="126"
                stroke-dashoffset="42"
                stroke-linecap="round"
              />
            </svg>
            <div class="text-center mt-2 mb-4 fw-bold">‡∏£‡∏∞‡∏î‡∏±‡∏ö Silver</div>
          </div>

        
          <p>
            ‡∏™‡∏∞‡∏™‡∏°‡∏≠‡∏µ‡∏Å <strong>100,000</strong> ‡∏û‡πâ‡∏≠‡∏¢‡∏ó‡πå ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô <strong>31/12/65</strong
            ><br />‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô <strong>Gold</strong> ‡πÉ‡∏ô‡∏õ‡∏µ 2568
          </p>

          <button
            class="btn btn-primary me-2"
            style="background-color: #2881c3; border-color: #2881c3"
            data-bs-toggle="modal"
            data-bs-target="#scoreModal"
          >
            <i class="fa-solid fa-qrcode"></i> ‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏£‡∏±‡∏ö‡∏û‡πâ‡∏≠‡∏¢‡∏ó‡πå
          </button>

          <button
            class="btn btn-primary btn-sm me-2"
            style="background-color: #2881c3; border-color: #2881c3"
            onclick="refreshUserScore()"
          >
            <i class="fa-solid fa-arrows-rotate"></i>
          </button>
        </div>
      </div>

      <div id="Ads" class="card-img-top rounded-4 mt-3">
        <div
          id="carouselAdsControls"
          class="carousel slide"
          data-bs-ride="carousel"
        >
          

          <div class="carousel-inner rounded-4 overflow-hidden">
            <div class="carousel-item active">
              <img
                src="https://lh3.googleusercontent.com/d/17b8m4ZImHbRfoBxXot8lAe5hIkbPGMii"
                class="d-block w-100"
                alt="Ad 1"
              />
            </div>
            <div class="carousel-item">
              <img
                src="https://lh3.googleusercontent.com/d/11lGfEtazBUMGiJKpmp5SGbHVsZCjKr0J"
                class="d-block w-100"
                alt="Ad 2"
              />
            </div>
            <div class="carousel-item">
              <img
                src="https://lh3.googleusercontent.com/d/1vbqgVSYG_HWtktR4Q7gi4-ti5S0PVX-W"
                class="d-block w-100"
                alt="Ad 3"
              />
            </div>
          </div>

          <button
            class="carousel-control-prev"
            type="button"
            data-bs-target="#carouselAdsControls"
            data-bs-slide="prev"
          >
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</span>
          </button>
          <button
            class="carousel-control-next"
            type="button"
            data-bs-target="#carouselAdsControls"
            data-bs-slide="next"
          >
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Modal: Add Score -->
    <div
      class="modal fade"
      id="scoreModal"
      tabindex="-1"
      aria-labelledby="scoreModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h4 class="modal-title" id="scoreModalLabel">
              <i class="fa-solid fa-qrcode"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°
            </h4>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="‡∏õ‡∏¥‡∏î"
            ></button>
          </div>
          <div class="modal-body text-center">
            <div
              id="qr-reader"
              style="width: 100%; max-width: 400px; margin: auto"
            ></div>

            <!-- ‡πÉ‡∏ô Modal ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏° dropdown ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢ -->
            <div class="form-group mt-3">
              <label for="cameraSelect" class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á</label>
              <select id="cameraSelect" class="form-control"></select>
            </div>

            <hr class="my-4" />

            <div class="form-group">
              <label for="secretCode" class="form-label"
                >‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</label
              >
              <input
                type="text"
                id="secretCode"
                class="form-control text-center"
                placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏•‡∏±‡∏ö"
              />
              <button onclick="submitSecretCode()" class="btn btn-success mt-3">
                <i class="fa-solid fa-check"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
         const serverUrl = "https://script.google.com/macros/s/AKfycbwEVCoCvHCBHa--c0al1L7vwC5TOR64XweMyZl3xcfFT-6TYLfLyPM2BImJoQQP9ATeGQ/exec"; /// exec
      const liffID = "2007333975-podn6BlY";
      const jsonUrl = "https://opensheet.elk.sh/1LMmd0jCuf_4ac0lTUehZiVZ5SuKm1HnCVmf6Vs483IU/Score";

      let html5QrCode;
      let currentCameraId = null;

      $(document).ready(function () {
        $('#regSection').hide();

        liff.init({ liffId: liffID }).then(() => {
          if (liff.isLoggedIn()) {
            $.LoadingOverlay("show", {
              image: "",
              fontawesome: "fa fa-spinner fa-spin",
              text: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..."
            });

            liff.getProfile().then(profile => {
              const uid = profile.userId;
              $('#uid').val(uid);
              $('#profilePic').attr('src', profile.pictureUrl);

              fetch(jsonUrl)
                .then(res => res.json())
                .then(data => {
                  const userData = data.find(d => d.Uid === uid);
                  if (userData) {
                    $('#displaySection').show();
                    $('#username').text(userData.Name);
                    $('#phone').html(`<i class="fas fa-phone"></i> ${userData.Tel}`);
                    $('.text-muted span:first').text(`üòÄ ${userData.Position} | ‡∏£‡∏´‡∏±‡∏™ ${userData.Passport}`);
                    $('#profilePic').attr('src', profile.pictureUrl);

                    let score = parseInt(userData.Score || "0");
                    // $('#points').text(score);
                    $('#points').text(score.toLocaleString());


                    updateProgressBar(score);
                  } else {
                    $('#regSection').show();
                    $('#displaySection').hide();
                  }
                  $.LoadingOverlay("hide");
                })
                .catch(error => {
                  console.error("Fetch error:", error);
                  $.LoadingOverlay("hide");
                  Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "error");
                });
            });
          } else {
            liff.login();
          }
        }).catch(err => console.error(err));

        $('#dataForm').ajaxForm({
          url: serverUrl,
          type: 'POST',
          dataType: 'json',
          beforeSubmit: function () {
            Swal.fire({
              title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...',
              allowOutsideClick: false,
              didOpen: () => Swal.showLoading()
            });
          },
          success: function (response) {
            if (response.status === 'success') {
              Swal.fire({
                icon: 'success',
                title: '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß'
              });

              $('#username').text($('#name').val());
              $('#phone').html('<i class="fas fa-phone"></i> ' + $('#telephone').val());
              const room = $('#room').val();
              const passport = $('#passport').val();
              $('.text-muted span:first').text(`‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ${room} ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${passport}`);
              $('#points').text('0');

              $('#regSection').hide();
              $('#displaySection').show();

              document.getElementById("progressCurve").style.strokeDashoffset = 126;
            } else {
              Swal.fire({
                icon: 'error',
                title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
                text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ'
              });
            }
          },
          error: function () {
            Swal.fire({
              icon: 'error',
              title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
              text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ'
            });
          }
        });
      });

      // ===== ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ =====

      function submitSecretCode() {
        const code = $('#secretCode').val().trim();
        if (!code) {
          Swal.fire("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏•‡∏±‡∏ö");
          return;
        }

        $.LoadingOverlay("show");
        fetch(serverUrl, {
          method: "POST",
          body: new URLSearchParams({
            uid: $('#uid').val(),
            code: code,
            type: 'manual'
          })
        }).then(res => res.json()).then(data => {
          $.LoadingOverlay("hide");
          if (data.status === "success") {
            Swal.fire("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡πâ‡∏ß", "success");
            $('#scoreModal').modal('hide');
            refreshUserScore();
          } else if (data.status === "used") {
            Swal.fire("‡∏£‡∏´‡∏±‡∏™‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß", "‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà", "warning");
          } else {
            Swal.fire("‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á", "error");
          }
        }).catch(err => {
          $.LoadingOverlay("hide");
          Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "error");
        });
      }

      function onScanSuccess(decodedText, decodedResult) {
        $('#scoreModal').modal('hide');
        $.LoadingOverlay("show");

        fetch(serverUrl, {
          method: "POST",
          body: new URLSearchParams({
            uid: $('#uid').val(),
            code: decodedText,
            type: 'scan'
          })
        })
        .then(res => res.json())
        .then(data => {
          $.LoadingOverlay("hide");

          if (data.status === "success") {
            Swal.fire("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", `‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å QR ‡πÅ‡∏•‡πâ‡∏ß (+${data.point})`, "success");
            refreshUserScore();
          } else if (data.status === "invalid") {
            Swal.fire("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ QR ‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ", data.message || "QR ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß", "error");
          } else {
            Swal.fire("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á", "error");
          }
        })
        .catch(err => {
          $.LoadingOverlay("hide");
          Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô", "error");
        });
      }

      // ============ ‡∏Å‡∏•‡πâ‡∏≠‡∏á ============

      $('#scoreModal').on('shown.bs.modal', function () {
        if (!html5QrCode) {
          html5QrCode = new Html5Qrcode("qr-reader");
        }

        Html5Qrcode.getCameras().then(cameras => {
          if (cameras && cameras.length) {
            $('#cameraSelect').empty();
            cameras.forEach(camera => {
              $('#cameraSelect').append(new Option(camera.label || `Camera ${camera.id}`, camera.id));
            });
            currentCameraId = cameras[0].id;
            startScanner(currentCameraId);
          }
        }).catch(err => {
          console.error("Camera fetch error:", err);
          Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á", "error");
        });
      });

      $('#cameraSelect').on('change', function () {
        const selectedCameraId = $(this).val();
        if (selectedCameraId !== currentCameraId) {
          stopScanner().then(() => {
            startScanner(selectedCameraId);
            currentCameraId = selectedCameraId;
          });
        }
      });

      function startScanner(cameraId) {
        html5QrCode.start(
          { deviceId: { exact: cameraId } },
          {
            fps: 10,
            qrbox: 250
          },
          onScanSuccess
        ).catch(err => {
          console.error("Camera start error:", err);
          Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ", "error");
        });
      }

      function stopScanner() {
        if (html5QrCode && html5QrCode.getState() === Html5QrcodeScannerState.SCANNING) {
          return html5QrCode.stop();
        }
        return Promise.resolve();
      }

      $('#scoreModal').on('hidden.bs.modal', function () {
        stopScanner().then(() => {
          html5QrCode.clear();
          html5QrCode = null;
        }).catch(err => {
          console.warn("Stop camera error", err);
        });
      });

      // ===== ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏° =====

      function refreshUserScore() {
        fetch(jsonUrl)
          .then(res => res.json())
          .then(data => {
            const uid = $('#uid').val();
            const userData = data.find(d => d.Uid === uid);
            if (userData) {
              let score = parseInt(userData.Score || "0");
              $('#points').text(score);
              updateProgressBar(score);
            }
          });
      }

      
      function updateProgressBar(score) {
  let currentTierMin = 0;
  let nextTierScore = 100000;

  if (score >= 1000000) {
    currentTierMin = 1000000;
    nextTierScore = 5000000;
  } else if (score >= 500000) {
    currentTierMin = 500000;
    nextTierScore = 1000000;
  } else if (score >= 100000) {
    currentTierMin = 100000;
    nextTierScore = 500000;
  }

  const relativeProgress = (score - currentTierMin) / (nextTierScore - currentTierMin);
  const totalDashLength = 126;
  const dashOffset = totalDashLength * (1 - relativeProgress);
  document.getElementById("progressCurve").style.strokeDashoffset = dashOffset;

  let tierText = "‡∏£‡∏∞‡∏î‡∏±‡∏ö Silver";
  let bgClass = "bg-silver";

  if (score >= 1000000) {
    tierText = "‡∏£‡∏∞‡∏î‡∏±‡∏ö Supreme";
    bgClass = "bg-supreme";
  } else if (score >= 500000) {
    tierText = "‡∏£‡∏∞‡∏î‡∏±‡∏ö Diamond";
    bgClass = "bg-diamond";
  } else if (score >= 100000) {
    tierText = "‡∏£‡∏∞‡∏î‡∏±‡∏ö Gold";
    bgClass = "bg-gold";
  }

  $('.d-flex').removeClass("bg-silver bg-gold bg-diamond bg-supreme").addClass(bgClass);
  $('.text-center.mt-2.mb-4.fw-bold').text(tierText);

  let remaining = nextTierScore - score;
  if (tierText === "‡∏£‡∏∞‡∏î‡∏±‡∏ö Supreme") {
    $('p:contains("‡∏™‡∏∞‡∏™‡∏°‡∏≠‡∏µ‡∏Å")').html(`‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß üéâ`);
  } else {
    let nextTierName =
      tierText === "‡∏£‡∏∞‡∏î‡∏±‡∏ö Diamond" ? "Supreme" :
      tierText === "‡∏£‡∏∞‡∏î‡∏±‡∏ö Gold" ? "Diamond" :
      "Gold";
    $('p:contains("‡∏™‡∏∞‡∏™‡∏°‡∏≠‡∏µ‡∏Å")').html(
      `‡∏™‡∏∞‡∏™‡∏°‡∏≠‡∏µ‡∏Å <strong>${remaining.toLocaleString()}</strong> ‡∏û‡πâ‡∏≠‡∏¢‡∏ó‡πå ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô <strong>31/12/68</strong><br>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô <strong>${nextTierName}</strong> ‡πÉ‡∏ô‡∏õ‡∏µ 2568`
    );
  }
}

      
      
    </script>

    <footer
      style="
        font-size: 14px;
        background-color: #2881c3;
        color: white;
        padding: 10px;
      "
    >
      ¬©
      <script>
        document.write(new Date().getFullYear());
      </script>
      Copyright | ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡∏´‡∏≠‡∏°‡∏à‡∏≠‡∏°‡∏ã‡∏ô
      <a
        href="https://www.facebook.com/thaninbanana"
        target="_blank"
        style="color: white; margin-left: 10px"
        ><i class="fa-brands fa-facebook"></i
      ></a>
      <a
        href="https://www.youtube.com"
        target="_blank"
        style="color: white; margin-left: 10px"
        ><i class="fa-brands fa-youtube"></i
      ></a>
    </footer>
  </body>
</html>
