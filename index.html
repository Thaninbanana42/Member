<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="https://img5.pic.in.th/file/secure-sv1/MTcircle.png" type="image/png">
    <title>Royal Point</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Google Font (‡πÑ‡∏ó‡∏¢‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏ß‡∏¢) -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.form/4.3.0/jquery.form.min.js"></script>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Font Awesome + Boxicons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"/>
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet"/>

    <!-- SweetAlert2 -->
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Loading Overlay -->
    <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>

    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <!-- html5-qrcode -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
      :root{
        --brand:#2881c3;
        --brand-600:#1e6aa3;
        --text:#2e2e2e;
        --muted:#697586;
        --card-bg:#ffffff;
        --soft:#f5f8fc;
        --radius:1.25rem;
      }
      html,body{
        font-family: "Prompt", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans Thai", sans-serif;
        color:var(--text); background:#f3f6fb;
      }

      /* Hero */
      .hero{
        background: radial-gradient(1200px 400px at 50% -100px, rgba(40,129,195,.18), transparent),
                    linear-gradient(180deg, #ffffff, #f7fbff);
        border-bottom: 1px solid #e8eef6;
      }
      .brand-badge{
        display:inline-flex; align-items:center; gap:.5rem;
        background:#eaf4fd; color:var(--brand); padding:.35rem .75rem; border-radius:999px; font-weight:600; font-size:.9rem;
      }

      /* Cards */
      .card-soft{
        background:var(--card-bg);
        border:none;
        border-radius: var(--radius);
        box-shadow: 0 8px 24px rgba(22, 40, 64, .06);
      }
      .card-section-title{ font-weight:700; color:var(--brand); }

      /* Buttons */
      .btn-brand{ background:var(--brand); border-color:var(--brand); color:#fff; }
      .btn-brand:hover{ background:var(--brand-600); border-color:var(--brand-600); color:#fff; }
      .btn-ghost{ background:#eaf4fd; color:var(--brand); border:none; }
      .btn-ghost:hover{ background:#d9ecfb; color:var(--brand-600); }

      /* Inputs */
      .form-label{ font-weight:600; color:#364152; }
      .form-control, .form-select{
        border-radius:.9rem; border:1px solid #d8e2ee; padding:.75rem 1rem;
      }
      .form-control:focus, .form-select:focus{
        border-color: var(--brand);
        box-shadow: 0 0 0 .15rem rgba(40,129,195,.15);
      }
      .input-icon{ position:absolute; left:.9rem; top:50%; transform:translateY(-50%); color:#8aa9c4; }
      .with-icon{ padding-left:2.2rem; }

      /* Tier backgrounds */
      .bg-silver{ background:linear-gradient(135deg,#f0f3f7,#ffffff); color:#394f65; }
      .bg-gold{ background:linear-gradient(135deg,#ffe79a,#fff7d6); color:#6b4e00; }
      .bg-diamond{ background:linear-gradient(135deg,#c7e9ff,#eef9ff); color:#0f4b66; }
      .bg-supreme{ background:linear-gradient(135deg,#111,#353535 60%, #fafafa); color:#f0b35a; }

      /* Profile strip */
      .profile-strip{
        border-radius: var(--radius);
        padding: 1rem 1.25rem;
        box-shadow: 0 8px 24px rgba(22,40,64,.06);
      }
      .profile-name{ font-weight:700; }
      .profile-meta{ color:var(--muted); font-size:.92rem; }

      /* Progress (semi circle) */
      .progress-wrap{ position:relative; width:100%; max-width:520px; margin: 0 auto; }
      .progress-value{
        position:absolute; left:50%; top:45%; transform:translate(-50%,-50%);
        font-weight:800; font-size:1.6rem; color:var(--brand);
      }
      .tier-text{ font-weight:700; color: var(--brand); }

      /* Carousel */
      .carousel .carousel-item img{ aspect-ratio: 16 / 9; object-fit: cover; }
      .carousel-control-prev-icon, .carousel-control-next-icon{ filter: drop-shadow(0 2px 6px rgba(0,0,0,.25)); }

      /* Footer */
      footer{ background: var(--brand); color:#fff; padding: 14px 0; margin-top: 32px; }
      footer .inner{ display:flex; align-items:center; justify-content:center; gap:12px; flex-wrap:wrap; max-width: 1100px; margin: 0 auto; }
      footer a{ color:#fff; opacity:.9; } footer a:hover{ opacity:1; }

      /* Helper */
      .rounded-3xl{ border-radius: 1.5rem; }
      #displaySection{ display:none; }
    </style>
  </head>

  <body>
    <!-- Hero -->
    <div class="hero">
      <div class="container py-3 py-md-4 d-flex align-items-center justify-content-between">
        <span class="brand-badge"><i class="fa-solid fa-crown"></i> Royal Point</span>
        <span class="text-muted small">VIP Loyalty</span>
      </div>
    </div>

    <div class="container my-3 my-md-4">
      <!-- Header image -->
      <img src="https://lh3.googleusercontent.com/d/1AvLa6L3Xp-nJKy9ir6u2J2YmBeZtBDFW" class="w-100 rounded-3xl shadow-sm" alt="Header"/>

      <!-- Register Section -->
      <div id="regSection" class="row justify-content-center mt-4">
        <div class="col-lg-8">
          <div class="card-soft p-4 p-md-5">
            <h2 class="text-center card-section-title mb-1">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ VIP</h2>
            <p class="text-center text-muted mb-4">‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡∏™‡∏∞‡∏™‡∏°‡∏û‡πâ‡∏≠‡∏¢‡∏ó‡πå ‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</p>

            <form id="dataForm" class="list">
              <!-- uid (hidden) -->
              <input type="text" class="form-control" id="uid" name="uid" style="display:none"/>

              <div class="row g-3">
                <div class="col-md-6">
                  <label for="name" class="form-label">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                  <div class="position-relative">
                    <i class="fa-regular fa-user input-icon"></i>
                    <input type="text" class="form-control with-icon" id="name" name="name" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required/>
                  </div>
                </div>

                <div class="col-md-6">
                  <label for="passport" class="form-label"><i class='bx bxs-building me-1'></i>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</label>
                  <div class="position-relative">
                    <i class="bx bxs-building input-icon"></i>
                    <input type="text" class="form-control with-icon" id="passport" name="passport" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô" required/>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <label for="room" class="form-label">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                  <select class="form-select" id="room" name="room" required>
                    <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</option>
                    <option value="‡∏ô‡∏≤‡∏¢‡∏ä‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏ç‡πà">‡∏ô‡∏≤‡∏¢‡∏ä‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏ç‡πà</option>
                    <option value="‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£">‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£</option>
                    <option value="‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô</option>
                    <option value="‡∏Ñ‡∏£‡∏π/‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå">‡∏Ñ‡∏£‡∏π/‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå</option>
                    <option value="‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
                  </select>
                </div>

                <div class="col-md-6">
                  <label for="dob" class="form-label">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label>
                  <div class="position-relative">
                    <i class="fa-regular fa-calendar input-icon"></i>
                    <input type="date" class="form-control with-icon" id="dob" name="dob" required/>
                  </div>
                </div>

                <div class="col-md-6">
                  <label for="telephone" class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                  <div class="position-relative">
                    <i class="fa-solid fa-phone input-icon"></i>
                    <input type="tel" class="form-control with-icon" id="telephone" name="telephone" placeholder="0xx-xxx-xxxx" required/>
                  </div>
                </div>
              </div>

              <button type="submit" class="btn btn-brand btn-lg w-100 mt-4">
                <i class="fa-solid fa-user-plus me-1"></i> ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- Display Section -->
      <div id="displaySection" class="list mt-4">
        <!-- Profile strip -->
        <div class="profile-strip d-flex align-items-center bg-silver">
          <img id="profilePic" src="https://placehold.co/60x60" class="rounded-circle border border-2 border-white shadow me-3" style="width:60px;height:60px" alt="profile"/>

          <div>
            <div class="profile-name" id="username">Thanin Pongyakate</div>
            <div class="profile-meta">
              <span>üòÄ ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á | </span><br/>
              <span id="phone"><i class="fas fa-phone"></i> 0906616611</span>
            </div>
          </div>

          <div class="ms-auto text-end">
            <div class="fw-bold">
              <div class="text-uppercase small text-muted mb-1">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°</div>
              <div class="d-flex align-items-baseline justify-content-end gap-2">
                <i class="fas fa-coins" style="color:var(--brand)"></i>
                <h2 id="points" class="mb-0" style="color:var(--brand)">0</h2>
              </div>
            </div>
          </div>
        </div>

        <!-- Tier + actions -->
        <div class="text-center mt-4">
          <div class="progress-wrap mb-2">
            <svg viewBox="0 0 100 50" class="w-100">
              <path d="M 10 50 A 40 40 0 0 1 90 50" stroke="#eef2f7" stroke-width="10" fill="none"/>
              <path id="progressCurve" d="M 10 50 A 40 40 0 0 1 90 50" stroke="var(--brand)" stroke-width="10" fill="none" stroke-dasharray="126" stroke-dashoffset="126" stroke-linecap="round"/>
            </svg>
            <div class="progress-value" id="progressValue">0%</div>
          </div>
          <div class="tier-text mb-3" id="tierText">‡∏£‡∏∞‡∏î‡∏±‡∏ö Silver</div>

          <p id="tierHint" class="mb-4 text-muted">
            ‡∏™‡∏∞‡∏™‡∏°‡∏≠‡∏µ‡∏Å <strong>100,000</strong> ‡∏û‡πâ‡∏≠‡∏¢‡∏ó‡πå ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô <strong>31/12/68</strong><br>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô <strong>Gold</strong> ‡πÉ‡∏ô‡∏õ‡∏µ 2568
          </p>

          <div class="d-flex justify-content-center gap-2">
            <button class="btn btn-brand" data-bs-toggle="modal" data-bs-target="#scoreModal">
              <i class="fa-solid fa-qrcode me-1"></i> ‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏£‡∏±‡∏ö‡∏û‡πâ‡∏≠‡∏¢‡∏ó‡πå
            </button>
            <button class="btn btn-ghost" onclick="refreshUserScore()" title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô">
              <i class="fa-solid fa-arrows-rotate"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Ads -->
      <div id="Ads" class="card-soft overflow-hidden mt-4">
        <div id="carouselAdsControls" class="carousel slide" data-bs-ride="carousel">
          <div class="carousel-inner rounded-3xl">
            <div class="carousel-item active">
              <img src="https://lh3.googleusercontent.com/d/17b8m4ZImHbRfoBxXot8lAe5hIkbPGMii" class="d-block w-100" alt="Ad 1"/>
            </div>
            <div class="carousel-item">
              <img src="https://lh3.googleusercontent.com/d/11lGfEtazBUMGiJKpmp5SGbHVsZCjKr0J" class="d-block w-100" alt="Ad 2"/>
            </div>
            <div class="carousel-item">
              <img src="https://lh3.googleusercontent.com/d/1vbqgVSYG_HWtktR4Q7gi4-ti5S0PVX-W" class="d-block w-100" alt="Ad 3"/>
            </div>
          </div>

          <button class="carousel-control-prev" type="button" data-bs-target="#carouselAdsControls" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#carouselAdsControls" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Modal: Add Score -->
    <div class="modal fade" id="scoreModal" tabindex="-1" aria-labelledby="scoreModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
          <div class="modal-header bg-white">
            <h4 class="modal-title" id="scoreModalLabel">
              <i class="fa-solid fa-qrcode me-1" style="color:var(--brand)"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°
            </h4>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="‡∏õ‡∏¥‡∏î"></button>
          </div>
          <div class="modal-body text-center">
            <div id="qr-reader" style="width:100%; max-width: 420px; margin:auto;"></div>

            <div class="form-group mt-3" style="max-width:420px; margin: 0 auto;">
              <label for="cameraSelect" class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á</label>
              <select id="cameraSelect" class="form-select"></select>
            </div>

            <hr class="my-4"/>

            <div class="form-group" style="max-width:420px; margin: 0 auto;">
              <label for="secretCode" class="form-label">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</label>
              <input type="text" id="secretCode" class="form-control text-center" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏•‡∏±‡∏ö"/>
              <button onclick="submitSecretCode()" class="btn btn-brand mt-3 w-100">
                <i class="fa-solid fa-check me-1"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== JS (‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö) ===== -->
    <script>
      // ====== CONFIG (‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏û‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°) ======
      const serverUrl = "https://script.google.com/macros/s/AKfycbwEVCoCvHCBHa--c0al1L7vwC5TOR64XweMyZl3xcfFT-6TYLfLyPM2BImJoQQP9ATeGQ/exec"; /// exec
      const liffID    = "2007333975-podn6BlY";
      const jsonUrl   = "https://opensheet.elk.sh/1LMmd0jCuf_4ac0lTUehZiVZ5SuKm1HnCVmf6Vs483IU/Score";

      // ====== STATE ======
      let html5QrCode;
      let currentCameraId = null;
      let scanning = false; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô error state ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á

      // ====== INIT ======
      $(document).ready(function () {
        $('#regSection').hide();

        liff.init({ liffId: liffID }).then(() => {
          if (liff.isLoggedIn()) {
            $.LoadingOverlay("show", { image: "", fontawesome: "fa fa-spinner fa-spin", text: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..." });

            liff.getProfile().then(profile => {
              const uid = profile.userId;
              $('#uid').val(uid);
              $('#profilePic').attr('src', profile.pictureUrl);

              fetch(jsonUrl)
                .then(res => res.json())
                .then(data => {
                  const userData = data.find(d => d.Uid === uid);
                  if (userData) {
                    // ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß
                    $('#displaySection').show();
                    $('#username').text(userData.Name || "-");
                    $('#phone').html(`<i class="fas fa-phone"></i> ${userData.Tel || "-"}`);
                    $('.profile-meta span:first').text(`üòÄ ${userData.Position || "-"} | ${userData.Passport || "-"}`);
                    $('#profilePic').attr('src', profile.pictureUrl);

                    const score = parseInt(userData.Score || "0", 10);
                    $('#points').text(score.toLocaleString());
                    updateProgressBar(score);
                  } else {
                    // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏°‡∏±‡∏Ñ‡∏£
                    $('#regSection').show();
                    $('#displaySection').hide();
                  }
                  $.LoadingOverlay("hide");
                })
                .catch(error => {
                  console.error("Fetch error:", error);
                  $.LoadingOverlay("hide");
                  Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "error");
                });
            });
          } else {
            liff.login();
          }
        }).catch(err => console.error(err));

        // ===== ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ GAS) =====
        $('#dataForm').ajaxForm({
          url: serverUrl,
          type: 'POST',
          dataType: 'json',
          beforeSubmit: function () {
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
          },
          success: function (response) {
            if (response.status === 'success') {
              Swal.fire({ icon: 'success', title: '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß' });

              $('#username').text($('#name').val());
              $('#phone').html('<i class="fas fa-phone"></i> ' + ($('#telephone').val() || '-'));
              const room = $('#room').val();
              const passport = $('#passport').val();
              $('.profile-meta span:first').text(`üòÄ ${room} | ‡∏£‡∏´‡∏±‡∏™ ${passport}`);
              $('#points').text('0');

              $('#regSection').hide();
              $('#displaySection').show();

              // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏£‡∏≤‡∏ü
              document.getElementById("progressCurve").style.strokeDashoffset = 126;
              $('#progressValue').text('0%');
              $('#tierText').text('‡∏£‡∏∞‡∏î‡∏±‡∏ö Silver');
              $('#tierHint').html(`‡∏™‡∏∞‡∏™‡∏°‡∏≠‡∏µ‡∏Å <strong>${(100000).toLocaleString()}</strong> ‡∏û‡πâ‡∏≠‡∏¢‡∏ó‡πå ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô <strong>31/12/68</strong><br>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô <strong>Gold</strong> ‡πÉ‡∏ô‡∏õ‡∏µ 2568`);
            } else {
              Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ' });
            }
          },
          error: function () {
            Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ' });
          }
        });
      });

      // ===== ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ‚Äú‡∏£‡∏´‡∏±‡∏™‡∏•‡∏±‡∏ö‚Äù =====
      function submitSecretCode() {
        const code = $('#secretCode').val().trim();
        if (!code) { Swal.fire("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏•‡∏±‡∏ö"); return; }

        $.LoadingOverlay("show");
        fetch(serverUrl, {
          method: "POST",
          body: new URLSearchParams({ uid: $('#uid').val(), code: code, type: 'manual' })
        })
        .then(res => res.json())
        .then(data => {
          $.LoadingOverlay("hide");
          if (data.status === "success") {
            Swal.fire("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡πâ‡∏ß", "success");
            $('#scoreModal').modal('hide');
            refreshUserScore();
          } else if (data.status === "used") {
            Swal.fire("‡∏£‡∏´‡∏±‡∏™‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß", "‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà", "warning");
          } else {
            Swal.fire("‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á", "error");
          }
        })
        .catch(() => {
          $.LoadingOverlay("hide");
          Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "error");
        });
      }

      // ===== ‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à =====
      function onScanSuccess(decodedText) {
        $('#scoreModal').modal('hide');
        $.LoadingOverlay("show");

        fetch(serverUrl, {
          method: "POST",
          body: new URLSearchParams({ uid: $('#uid').val(), code: decodedText, type: 'scan' })
        })
        .then(res => res.json())
        .then(data => {
          $.LoadingOverlay("hide");
          if (data.status === "success") {
            Swal.fire("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", `‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å QR ‡πÅ‡∏•‡πâ‡∏ß (+${data.point})`, "success");
            refreshUserScore();
          } else if (data.status === "invalid") {
            Swal.fire("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ QR ‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ", data.message || "QR ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß", "error");
          } else {
            Swal.fire("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á", "error");
          }
        })
        .catch(() => {
          $.LoadingOverlay("hide");
          Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô", "error");
        });
      }

      // ====== ‡∏Å‡∏•‡πâ‡∏≠‡∏á (‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î + ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á) ======
      $('#scoreModal').on('shown.bs.modal', function () {
        if (!html5QrCode) { html5QrCode = new Html5Qrcode("qr-reader"); }

        Html5Qrcode.getCameras().then(cameras => {
          if (cameras && cameras.length) {
            $('#cameraSelect').empty();
            cameras.forEach(camera => $('#cameraSelect').append(new Option(camera.label || `Camera ${camera.id}`, camera.id)));
            currentCameraId = cameras[0].id;
            startScanner(currentCameraId);
          } else {
            Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á", "error");
          }
        }).catch(err => {
          console.error("Camera fetch error:", err);
          Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á", "error");
        });
      });

      $('#cameraSelect').on('change', function () {
        const selectedCameraId = $(this).val();
        if (selectedCameraId !== currentCameraId) {
          stopScanner().then(() => { startScanner(selectedCameraId); currentCameraId = selectedCameraId; });
        }
      });

      function startScanner(cameraId) {
        html5QrCode.start(
          { deviceId: { exact: cameraId } },
          { fps: 10, qrbox: 250 },
          onScanSuccess
        ).then(() => { scanning = true; })
        .catch(err => {
          console.error("Camera start error:", err);
          Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ", "error");
        });
      }

      function stopScanner() {
        if (html5QrCode && scanning) {
          return html5QrCode.stop().then(() => { scanning = false; });
        }
        return Promise.resolve();
      }

      $('#scoreModal').on('hidden.bs.modal', function () {
        stopScanner()
          .then(() => { if (html5QrCode) { html5QrCode.clear(); html5QrCode = null; } })
          .catch(err => { console.warn("Stop camera error", err); });
      });

      // ===== Helpers =====
      function refreshUserScore() {
        fetch(jsonUrl)
          .then(res => res.json())
          .then(data => {
            const uid = $('#uid').val();
            const userData = data.find(d => d.Uid === uid);
            if (userData) {
              let score = parseInt(userData.Score || "0", 10);
              $('#points').text(score.toLocaleString());
              updateProgressBar(score);
            }
          });
      }

      function updateProgressBar(score) {
        let currentTierMin = 0;
        let nextTierScore = 100000;

        if (score >= 5000000) { // ‡∏Å‡∏±‡∏ô‡∏Ñ‡πà‡∏≤‡∏•‡πâ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
          currentTierMin = 5000000; nextTierScore = 5000000;
        } else if (score >= 1000000) {
          currentTierMin = 1000000; nextTierScore = 5000000;
        } else if (score >= 500000) {
          currentTierMin = 500000; nextTierScore = 1000000;
        } else if (score >= 100000) {
          currentTierMin = 100000; nextTierScore = 500000;
        }

        const relative = Math.max(0, Math.min(1, (score - currentTierMin) / (nextTierScore - currentTierMin || 1)));
        const totalDash = 126;
        const dashOffset = totalDash * (1 - relative);
        document.getElementById("progressCurve").style.strokeDashoffset = dashOffset;
        document.getElementById("progressValue").innerText = `${Math.round(relative * 100)}%`;

        let tierText = "‡∏£‡∏∞‡∏î‡∏±‡∏ö Silver", bgClass = "bg-silver";
        if (score >= 1000000) { tierText = "‡∏£‡∏∞‡∏î‡∏±‡∏ö Supreme"; bgClass = "bg-supreme"; }
        else if (score >= 500000) { tierText = "‡∏£‡∏∞‡∏î‡∏±‡∏ö Diamond"; bgClass = "bg-diamond"; }
        else if (score >= 100000) { tierText = "‡∏£‡∏∞‡∏î‡∏±‡∏ö Gold"; bgClass = "bg-gold"; }

        $('.profile-strip').removeClass("bg-silver bg-gold bg-diamond bg-supreme").addClass(bgClass);
        $('#tierText').text(tierText);

        const $hint = $('#tierHint');
        if (tierText === "‡∏£‡∏∞‡∏î‡∏±‡∏ö Supreme") {
          $hint.html(`‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß üéâ`);
        } else {
          let remaining = Math.max(0, (nextTierScore - score));
          let nextTierName = tierText === "‡∏£‡∏∞‡∏î‡∏±‡∏ö Diamond" ? "Supreme" : (tierText === "‡∏£‡∏∞‡∏î‡∏±‡∏ö Gold" ? "Diamond" : "Gold");
          $hint.html(`‡∏™‡∏∞‡∏™‡∏°‡∏≠‡∏µ‡∏Å <strong>${remaining.toLocaleString()}</strong> ‡∏û‡πâ‡∏≠‡∏¢‡∏ó‡πå ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô <strong>31/12/68</strong><br>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô <strong>${nextTierName}</strong> ‡πÉ‡∏ô‡∏õ‡∏µ 2568`);
        }
      }
    </script>

    <footer>
      <div class="inner">
        <span>¬© <script>document.write(new Date().getFullYear());</script> Copyright | ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡∏´‡∏≠‡∏°‡∏à‡∏≠‡∏°‡∏ã‡∏ô</span>
        <a href="https://www.facebook.com/thaninbanana" target="_blank" aria-label="Facebook"><i class="fa-brands fa-facebook"></i></a>
        <a href="https://www.youtube.com" target="_blank" aria-label="YouTube"><i class="fa-brands fa-youtube"></i></a>
      </div>
    </footer>
  </body>
</html>
